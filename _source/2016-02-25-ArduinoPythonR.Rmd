---
title: "Arduinoを測器に (Arduino, Python"
output: html_document
layout: post
categories: Python R Arduino
tags: Arduino lab Python R 
---

```{r setup, eval = TRUE, echo = FALSE, message= F}
require(ggplot2)
require(plyr)
require(dplyr)
require(knitr)
require(magrittr)
require(stringr)
require(data.table)
require(devtools)
require(tidyr)
opts_chunk$set(eval = TRUE,
               error = FALSE,
               prompt = FALSE,
               message = FALSE,
               echo = TRUE,
               fig.hight = 4,
               fig.width = 10,
               warning =FALSE)
```

# Arduinoとフォトダイオードで光の強さ (PFD) を測定する簡易測器を作る with Python

小さな容器の中の温度・湿度・光環境などを測定したい場合には、市販の測器だと大きすぎてうまく測定できない場合がある  
操作性の悪い測器を使うのが面倒な場合もある  
こういうとき、[Arduino](https://www.arduino.cc/)という小型マイコンと各種センサを使えば簡易な測定可能な場合がある  

もっぱらセンサとしてフォトダイオードを使って、可視外の光の強さ (PFD) の測定に使用している  
フォトダイオードは１つ数百円程度、波長選択性が高いなど、なかなか便利  
光の強さに応じて出力電流が変わるので適当な抵抗をかませて電圧をとる

### Arduinoでシリアル通信
Arduinoのマイコン上にコードを載せて操作するのが一般的な使用法  
この場合、言語がC/C++ライクなものになる (ちょっとやったけどしんどかった)  
即座に逃げた  

### Rでシリアル通信  
[こちら](http://d.hatena.ne.jp/dichika/20150611/p1)のサイトなどをみた  
ぱっとみ難しい  
ちょっと迷って逃げた

### Pythonでシリアル通信
`pyserial`というモジュールでいけそう  

```{r Write_Python, eval = F, engine = 'python'}
import csv
import serial

ser = serial.Serial(3) # Arduino uses COM4 in my environment
smoothing = 100 # log 100 data to confirm stability later

with open('ArduinoRead.csv', 'w') as f:
  writer = csv.writer(f)
  a = [ser.read(smoothing)]
  writer.writerow(a)
  f.close()

print("csv wrote")
```
出力値を記録するだけならこれで機能する  
Arduinoからserialポートへ流れてくる値を100文字読み込み、ArduinoRead.csvというファイルに書き込む  
ArduinoをUSBポートに挿して、`py Write_Python.py`でおしまい  

### Rで可視化
データを可視化する  
```{r Read_R}
# path to the csv file generated by Python
ArdOutput <- "~/Dropbox/working.dir/ArduinoRead.csv"

Ard_graph <- function(InputType){
  slope <- switch(InputType, X =  0.31703, Y = 0.28209, Z = 0.286312)
  intercept <- switch(InputType, X =  4.95123, Y = -1.34458, Z = -0.479106)
  
  ArdData <-
    read.csv(ArdOutput, sep = ":", header = FALSE) %>%
    unlist %>%
    { used_data <-  2:(length(.) - 1)
      
      data.frame(raw = .) %>%
      slice(used_data) %>%
      mutate(calibrated =  as.numeric(as.character(raw)) * slope + intercept,
             time = 1:length(used_data))
    }
  
  Meas.Time <- 
    file.info(ArdOutput)$mtime %>%
    format("%Y/%m/%d %H:%M:%S") %>%
    paste0("@", .)
  
  aveSD <-
    paste0("ave: ", sprintf("%.1f", mean(ArdData$calibrated)),
           ", SD: ", sprintf("%.2f", sd(ArdData$calibrated)))
  
  Ymax <- max(ceiling(ArdData$calibrated/10) * 10)
  Ymin <- min(floor(ArdData$calibrated/10) * 10)
  
  Fig_value <-
    ArdData %>%
    ggplot(aes(x = time, y = calibrated)) +
    geom_line() +
    geom_point() +
    ylim(c(Ymin, Ymax)) +
    annotate("text", label = Meas.Time,
             x = 0, y = Ymin, hjust = 0, vjust = 0, size = 10) +
    annotate("text", label = aveSD,
             x = 0, y = Ymax, hjust = 0, vjust = 1, size = 10)

  Fig_value %>%
    return
}


Ard_graph(InputType = "X") # InputType: Temperature, Weight... (calibrated before)
```

### RからPythonを動かしたい
"PythonでRを動かす"系は多いが逆は少ない  
コンパイルなる作業が必要な言語はどうしても避けてしまう  

### 参考ページ
[Arduino](https://www.arduino.cc/)  
[pyserial](https://pypi.python.org/pypi/pyserial)  
[シリアル通信用のパッケージ作りてえ (盆栽日記@Hatena::Diary)](http://d.hatena.ne.jp/dichika/20150611/p1)