---
title: "二項演算子 %in% を改良したかった"
date: 2016-03-10
---



<pre><code>## Warning in library(package, lib.loc = lib.loc, character.only = TRUE,
## logical.return = TRUE, : there is no package called &#39;agricolae&#39;</code></pre>
<pre><code>## Warning in library(package, lib.loc = lib.loc, character.only = TRUE,
## logical.return = TRUE, : there is no package called &#39;slackr&#39;</code></pre>
<p><code>%in%</code>をよく使う</p>
<pre class="r"><code>iris %&gt;%
  filter(Species %in% &quot;setosa&quot;) %&gt;%
  head</code></pre>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<p><code>data.table::between</code>もよく使う</p>
<pre class="r"><code># rows 4.5 ≤ Petal.Length ≤ 5.5
iris %&gt;%
  filter(between(Petal.Length, 4.5, 5.5)) %&gt;%
  head</code></pre>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 1          7.0         3.2          4.7         1.4 versicolor
## 2          6.4         3.2          4.5         1.5 versicolor
## 3          6.9         3.1          4.9         1.5 versicolor
## 4          6.5         2.8          4.6         1.5 versicolor
## 5          5.7         2.8          4.5         1.3 versicolor
## 6          6.3         3.3          4.7         1.6 versicolor</code></pre>
<pre class="r"><code># rows !(4.5 ≤ Petal.Length ≤ 5.5)
iris %&gt;%
  filter(!between(Petal.Length, 4.5, 5.5)) %&gt;%
  head</code></pre>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width Species
## 1          5.1         3.5          1.4         0.2  setosa
## 2          4.9         3.0          1.4         0.2  setosa
## 3          4.7         3.2          1.3         0.2  setosa
## 4          4.6         3.1          1.5         0.2  setosa
## 5          5.0         3.6          1.4         0.2  setosa
## 6          5.4         3.9          1.7         0.4  setosa</code></pre>
<p>排反を取得したいときにこんな感じで書きたくなる<br />
が、エラーを吐かれる</p>
<pre class="r"><code>iris %&gt;%
  filter(Species !%in% &quot;setosa&quot;)

Error: unexpected &#39;!&#39; in:
&quot;iris %&gt;%
  filter(Species !&quot;</code></pre>
<p><code>%in%</code>の背反をとるにはこう書く</p>
<pre class="r"><code>iris %&gt;%
  filter(!(Species %in% &quot;setosa&quot;)) %&gt;%
  head</code></pre>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 1          7.0         3.2          4.7         1.4 versicolor
## 2          6.4         3.2          4.5         1.5 versicolor
## 3          6.9         3.1          4.9         1.5 versicolor
## 4          5.5         2.3          4.0         1.3 versicolor
## 5          6.5         2.8          4.6         1.5 versicolor
## 6          5.7         2.8          4.5         1.3 versicolor</code></pre>
<p>直感的ではない(ように思う)</p>
<div id="in" class="section level3">
<h3><code>!%in%</code>を実装したかった</h3>
<p><code>%in%</code>の中身</p>
<pre class="r"><code># バッククオートで囲むと参照できる
`%in%`</code></pre>
<pre><code>## function (x, table) 
## match(x, table, nomatch = 0L) &gt; 0L
## &lt;bytecode: 0x7fe8ad0e2060&gt;
## &lt;environment: namespace:base&gt;</code></pre>
<p><code>!%in%</code>を素直に試みる</p>
<pre class="r"><code>`!%in%` &lt;-
  function (x, table){
    !match(x, table, nomatch = 0L) &gt; 0L
  }

# 関数作成はできる
`!%in%` %&gt;%
  print

# 実行はできない
iris %&gt;%
  filter(Species !%in% &quot;setosa&quot;)

Error: unexpected &#39;!&#39; in:
&quot;iris %&gt;%
  filter(Species !&quot;</code></pre>
<p>できなかった<br />
ので、代替品を作っておいた</p>
<pre class="r"><code>`%!in%` &lt;-
  function (x, table){
    !match(x, table, nomatch = 0L) &gt; 0L
  }

iris %&gt;%
  filter(Species %!in% &quot;setosa&quot;) %&gt;%
  head</code></pre>
<pre><code>##   Sepal.Length Sepal.Width Petal.Length Petal.Width    Species
## 1          7.0         3.2          4.7         1.4 versicolor
## 2          6.4         3.2          4.5         1.5 versicolor
## 3          6.9         3.1          4.9         1.5 versicolor
## 4          5.5         2.3          4.0         1.3 versicolor
## 5          6.5         2.8          4.6         1.5 versicolor
## 6          5.7         2.8          4.5         1.3 versicolor</code></pre>
<pre class="r"><code>session_info()</code></pre>
<pre><code>##  setting  value                       
##  version  R version 3.4.4 (2018-03-15)
##  system   x86_64, darwin15.6.0        
##  ui       X11                         
##  language (EN)                        
##  collate  en_US.UTF-8                 
##  tz       Asia/Tokyo                  
##  date     2018-04-24                  
## 
##  package      * version    date       source                          
##  assertthat     0.2.0      2017-04-11 CRAN (R 3.4.0)                  
##  backports      1.1.0      2017-05-22 CRAN (R 3.4.0)                  
##  base         * 3.4.4      2018-03-15 local                           
##  bindr          0.1        2016-11-13 CRAN (R 3.4.0)                  
##  bindrcpp     * 0.2        2017-06-17 CRAN (R 3.4.0)                  
##  bitops       * 1.0-6      2013-08-17 CRAN (R 3.4.0)                  
##  blogdown       0.6        2018-04-18 CRAN (R 3.4.4)                  
##  bookdown       0.7        2018-02-18 CRAN (R 3.4.3)                  
##  codetools      0.2-15     2016-10-05 CRAN (R 3.4.4)                  
##  colorspace     1.3-2      2016-12-14 CRAN (R 3.4.0)                  
##  compiler       3.4.4      2018-03-15 local                           
##  data.table   * 1.10.4-2   2017-10-12 cran (@1.10.4-)                 
##  datasets     * 3.4.4      2018-03-15 local                           
##  devtools     * 1.13.5     2018-02-18 cran (@1.13.5)                  
##  digest         0.6.15     2018-01-28 cran (@0.6.15)                  
##  doParallel     1.0.10     2015-10-14 cran (@1.0.10)                  
##  doRNG          1.6.6      2017-04-10 cran (@1.6.6)                   
##  dplyr        * 0.7.4      2017-09-28 cran (@0.7.4)                   
##  evaluate       0.10.1     2017-06-24 cran (@0.10.1)                  
##  foreach      * 1.4.3      2015-10-13 cran (@1.4.3)                   
##  ggplot2      * 2.2.1      2016-12-30 CRAN (R 3.4.0)                  
##  glue           1.2.0      2017-10-29 cran (@1.2.0)                   
##  graphics     * 3.4.4      2018-03-15 local                           
##  grDevices    * 3.4.4      2018-03-15 local                           
##  grid         * 3.4.4      2018-03-15 local                           
##  gridExtra    * 2.2.1      2016-02-29 cran (@2.2.1)                   
##  gtable       * 0.2.0      2016-02-26 CRAN (R 3.4.0)                  
##  htmltools      0.3.6      2017-04-28 CRAN (R 3.4.0)                  
##  iterators      1.0.8      2015-10-13 cran (@1.0.8)                   
##  knitr        * 1.17       2017-08-10 cran (@1.17)                    
##  lazyeval       0.2.1      2017-10-29 cran (@0.2.1)                   
##  lubridate    * 1.7.1      2017-11-03 cran (@1.7.1)                   
##  magrittr     * 1.5        2014-11-22 CRAN (R 3.4.0)                  
##  MASS         * 7.3-49     2018-02-23 CRAN (R 3.4.4)                  
##  memoise        1.1.0      2017-04-21 CRAN (R 3.4.0)                  
##  methods      * 3.4.4      2018-03-15 local                           
##  munsell        0.4.3      2016-02-13 CRAN (R 3.4.0)                  
##  parallel       3.4.4      2018-03-15 local                           
##  pforeach     * 1.3        2017-06-18 Github (hoxo-m/pforeach@2c44f3b)
##  pkgconfig      2.0.1      2017-03-21 CRAN (R 3.4.0)                  
##  pkgmaker       0.22       2014-05-14 cran (@0.22)                    
##  plyr         * 1.8.4      2016-06-08 CRAN (R 3.4.0)                  
##  purrr          0.2.4      2017-10-18 cran (@0.2.4)                   
##  R6             2.2.2      2017-06-17 CRAN (R 3.4.0)                  
##  RColorBrewer * 1.1-2      2014-12-07 CRAN (R 3.4.0)                  
##  Rcpp           0.12.16    2018-03-13 cran (@0.12.16)                 
##  RCurl        * 1.95-4.8   2016-03-01 CRAN (R 3.4.0)                  
##  registry       0.3        2015-07-08 cran (@0.3)                     
##  reshape2     * 1.4.2      2016-10-22 CRAN (R 3.4.0)                  
##  rlang          0.2.0      2018-02-20 CRAN (R 3.4.3)                  
##  rmarkdown      1.7        2017-11-10 cran (@1.7)                     
##  rngtools       1.2.4      2014-03-06 cran (@1.2.4)                   
##  rprojroot      1.2        2017-01-16 CRAN (R 3.4.0)                  
##  scales       * 0.5.0.9000 2017-11-16 Github (hadley/scales@d767915)  
##  stats        * 3.4.4      2018-03-15 local                           
##  stringi        1.1.6      2017-11-17 cran (@1.1.6)                   
##  stringr      * 1.3.0      2018-02-19 cran (@1.3.0)                   
##  tibble         1.3.4      2017-08-22 cran (@1.3.4)                   
##  tidyr        * 0.7.2      2017-10-16 cran (@0.7.2)                   
##  tools          3.4.4      2018-03-15 local                           
##  utils        * 3.4.4      2018-03-15 local                           
##  withr          2.1.2      2018-04-24 Github (jimhester/withr@79d7b0d)
##  xfun           0.1        2018-01-22 CRAN (R 3.4.3)                  
##  xtable         1.8-2      2016-02-05 cran (@1.8-2)                   
##  yaml           2.1.14     2016-11-12 CRAN (R 3.4.0)</code></pre>
</div>
